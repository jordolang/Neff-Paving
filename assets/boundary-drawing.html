<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Boundary Drawing Tool</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/ol3/4.6.5/ol.css" type="text/css">
    <style>
        #map {
            width: 100%;
            height: 100vh;
        }
        .toolbar {
            position: absolute;
            top: 10px;
            left: 10px;
            background: white;
            padding: 10px;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div id="map" class="map"></div>
    <div class="toolbar">
        <button id="drawPolygon">Draw Polygon</button>
        <button id="drawRectangle">Draw Rectangle</button>
        <button id="drawFreehand">Freehand</button>
        <button id="undo">Undo</button>
        <button id="redo">Redo</button>
        <button id="clear">Clear</button>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ol3/4.6.5/ol.js"></script>
    <script>
        // Initialize map with satellite imagery
        var raster = new ol.layer.Tile({
            source: new ol.source.OSM({
                attributions: ['Tiles &copy; <a href="https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer">ArcGIS</a>']
            })
        });

        var map = new ol.Map({
            target: 'map',
            layers: [raster],
            view: new ol.View({
                center: ol.proj.fromLonLat([0, 0]),
                zoom: 2
            })
        });

        // Drawing controls
        var draw, snap, modify;
        var features = new ol.Collection();
        var featureOverlay = new ol.layer.Vector({
            source: new ol.source.Vector({features: features}),
            style: new ol.style.Style({
                fill: new ol.style.Fill({color: 'rgba(0, 0, 255, 0.2)'}),
                stroke: new ol.style.Stroke({color: '#0000ff', width: 2})
            })
        });
        map.addLayer(featureOverlay);

        function addInteraction(type) {
            draw = new ol.interaction.Draw({
                features: features,
                type: type
            });
            modify = new ol.interaction.Modify({source: featureOverlay.getSource()});
            map.addInteraction(draw);
            map.addInteraction(modify);
            snap = new ol.interaction.Snap({source: featureOverlay.getSource()});
            map.addInteraction(snap);

            draw.on('drawend', calculateArea);
        }

        function calculateArea(evt) {
            var feature = evt.feature;
            var area = ol.sphere.getArea(feature.getGeometry(), {projection: map.getView().getProjection()});
            window.parent.postMessage({type: 'area', value: area}, '*');
        }

        document.getElementById('drawPolygon').onclick = function() {
            map.removeInteraction(draw);
            addInteraction('Polygon');
        };

        document.getElementById('drawRectangle').onclick = function() {
            map.removeInteraction(draw);
            addInteraction('Circle');
            snap.setActive(false);
        };

        document.getElementById('drawFreehand').onclick = function() {
            map.removeInteraction(draw);
            addInteraction('LineString');
        };

        // Undo/Redo functionality
        var undoStack = [], redoStack = [];
        
        map.on('pointerdown', function() {
            undoStack.push(features.getArray().slice());
        });

        document.getElementById('undo').onclick = function() {
            redoStack.push(undoStack.pop());
            restoreFeatures(undoStack[undoStack.length - 1]);
        };

        document.getElementById('redo').onclick = function() {
            var state = redoStack.pop();
            if (state) {
                restoreFeatures(state);
            }
        };

        function restoreFeatures(featuresArray) {
            features.clear();
            featureOverlay.getSource().clear();
            if (featuresArray) {
                featuresArray.forEach(function(feature) {
                    features.push(feature);
                });
            }
        }

        // Clear and Reset functionality
        document.getElementById('clear').onclick = function() {
            undoStack = [];
            redoStack = [];
            restoreFeatures([]);
        };

    </script>
</body>
</html>

